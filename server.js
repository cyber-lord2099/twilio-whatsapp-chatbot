require('dotenv').config();
const express = require('express');
const twilio = require('twilio');
const app = express();

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Twilio credentials
const accountSid = process.env.TWILIO_ACCOUNT_SID;
const authToken = process.env.TWILIO_AUTH_TOKEN;
const client = twilio(accountSid, authToken);
const twilioWhatsAppNumber = process.env.TWILIO_WHATSAPP_NUMBER;

// Store user state (in-memory; use a database in production)
const userState = {};

// Sub-schemes for each main scheme
const subSchemes = {
  '1': [
    '1. आश्रमशाळा',
    '2. शिष्यवृत्ती',
    '3. वसतीगृहे / आधार योजना'
  ],
  '2': [], // पायाभूत सुविधा संबंधित योजना has no sub-schemes
  '3': [
    '1. संस्था'
  ],
  '4': [
    '1. महामंडळे'
  ],
  '5': [] // इतर योजना has no sub-schemes
};

// Sub-scheme details
const subSchemeDetails = {
  '1': {
    '1': 'लाभ घेणारा प्रवर्ग: इतर मागास वर्ग, विमुक्त जाती, भटक्या जमाती आणि विशेष मागास प्रवर्ग\n\n१. आश्रमशाळा\n   निवासी शाळा ज्या मोफत शिक्षण आणि सुविधा प्रदान करतात.\n\n   १.१ विमुक्त जाती, भटक्या जमाती व विशेष मागास प्रवर्गासाठीच्या आश्रमशाळा\n   महाराष्ट्रातील विमुक्त जाती आणि भटक्या जमाती तसेच विशेष मागास प्रवर्गातील विद्यार्थ्यांसाठी ५३० प्राथमिक आश्रमशाळा, २९७ माध्यमिक आश्रमशाळा व १३८ उच्च माध्यमिक आश्रमशाळा चालविल्या जातात. या आश्रमशाळांमधून विद्यार्थ्यांना शासनाकडून मोफत निवास, भोजन, शालेय साहित्य, गणवेश (वर्षातून दोनदा) व अंथरुण-पांघरुण इत्यादी सोयी सुविधा पुरविल्या जातात. या आश्रमशाळांमध्ये शिक्षणासह विद्यार्थ्यांच्या सर्वांगीण विकासासाठी खेळ, सांस्कृतिक कार्यक्रम आणि आरोग्य तपासणी यासारख्या सुविधा देखील उपलब्ध आहेत. या शाळा ग्रामीण आणि दुर्गम भागात स्थापन केल्या गेल्या असून, त्यामुळे या प्रवर्गातील मुलांना शिक्षणाची संधी मिळते.\n\n   १.२ उसतोड कामगारांच्या मुलामुलींसाठी निवासी आश्रमशाळा\n   उसतोड कामगारांच्या मुला-मुलींसाठी बीड जिल्ह्यात ६ आश्रमशाळा चालविल्या जातात, ज्या त्यांच्या शिक्षणासाठी निवासी सुविधा पुरवतात. या शाळांमध्ये मुलांना शिक्षणासोबतच मोफत निवास, भोजन आणि शालेय साहित्य पुरवले जाते, ज्यामुळे त्यांच्या पालकांच्या स्थलांतरामुळे शिक्षणात खंड पडत नाही.\n\n   १.३ विद्यानिकेतन शाळा\n   नांदेड विभागातील नंदुरबार जिल्ह्यात १ विद्यानिकेतन शाळा चालविली जाते, जी विमुक्त जाती व भटक्या जमातीच्या विद्यार्थ्यांसाठी शैक्षणिक सुविधा प्रदान करते. या शाळेत विशेषतः गुणवंत विद्यार्थ्यांना प्रोत्साहन दिले जाते आणि त्यांना उच्च शिक्षणासाठी मार्गदर्शन केले जाते.',
    '2': 'लाभ घेणारा प्रवर्ग: इतर मागास वर्ग, विमुक्त जाती, भटक्या जमाती आणि विशेष मागास प्रवर्ग\n\n२. शिष्यवृत्ती\n   विविध स्तरांवर शिक्षणासाठी आर्थिक सहाय्य.\n\n   २.१ मॅट्रिकपूर्व शिष्यवृत्ती\n   इतर मागास वर्ग, विमुक्त जाती, भटक्या जमाती व विशेष मागास प्रवर्गातील विद्यार्थ्यांसाठी प्राथमिक आणि माध्यमिक शिक्षणाला प्रोत्साहन देण्यासाठी मॅट्रिकपूर्व शिष्यवृत्ती योजना राबविली जाते. या योजनेंतर्गत विद्यार्थ्यांना शालेय शुल्क, पुस्तके आणि गणवेशासाठी आर्थिक सहाय्य दिले जाते, ज्यामुळे त्यांचे शिक्षण सुरळीत चालते.\n\n   २.२ मॅट्रिकोत्तर शिष्यवृत्ती\n   इतर मागास वर्ग, विमुक्त जाती, भटक्या जमाती व विशेष मागास प्रवर्गातील विद्यार्थ्यांसाठी उच्च शिक्षणाला प्रोत्साहन देण्यासाठी मॅट्रिकोत्तर शिष्यवृत्ती योजना राबविली जाते. या योजनेंतर्गत महाविद्यालयीन शिक्षण घेणाऱ्या विद्यार्थ्यांना शुल्क माफी, निवास भत्ता आणि पुस्तकांसाठी आर्थिक सहाय्य मिळते.\n\n   २.३ परदेशात उच्च शिक्षणासाठी शिष्यवृत्ती योजना\n   इतर मागास वर्ग, विमुक्त जाती, भटक्या जमाती व विशेष मागास प्रवर्गातील गुणवंत विद्यार्थ्यांना परदेशात उच्च शिक्षणासाठी शिष्यवृत्ती प्रदान करण्याची योजना. या योजनेंतर्गत विद्यार्थ्यांना परदेशातील नामांकित विद्यापीठांमध्ये शिक्षण घेण्यासाठी शुल्क, प्रवास खर्च आणि निवासासाठी आर्थिक सहाय्य दिले जाते.',
    '3': 'लाभ घेणारा प्रवर्ग: इतर मागास वर्ग, विमुक्त जाती, भटक्या जमाती आणि विशेष मागास प्रवर्ग\n\n३. वसतीगृहे / आधार योजना\n   इतर मागास वर्ग, विमुक्त जाती, भटक्या जमाती आणि विशेष मागास प्रवर्गातील विद्यार्थ्यांसाठी निवास आणि शिक्षणासाठी सहाय्य.\n\n   ३.१ राज्यातील इतर मागास प्रवर्ग, विमुक्त जाती, भटक्या जमाती व विशेष मागास प्रवर्ग या प्रवर्गातील विद्यार्थ्यांसाठी जिल्हानिहाय वसतीगृहे\n   राज्यातील इतर मागास प्रवर्ग, विमुक्त जाती, भटक्या जमाती व विशेष मागास प्रवर्गातील विद्यार्थ्यांसाठी जिल्हानिहाय वसतीगृहे सुरु करण्यात आली आहेत, जिथे मोफत निवास, भोजन आणि शैक्षणिक सुविधा पुरविल्या जातात. या वसतीगृहांमध्ये विद्यार्थ्यांना अभ्यासासाठी शांत वातावरण, ग्रंथालय आणि मार्गदर्शन उपलब्ध आहे.\n\n   ३.२ ज्ञानज्योती सावित्रीबाई फुले आधार योजना\n   इतर मागास वर्ग, विमुक्त जाती, भटक्या जमाती व विशेष मागास प्रवर्गातील मुलींच्या शिक्षणाला आणि स्वावलंबनाला प्रोत्साहन देण्यासाठी आर्थिक सहाय्य प्रदान करणारी योजना. या योजनेंतर्गत मुलींना शालेय साहित्य, शुल्क माफी आणि आर्थिक प्रोत्साहन दिले जाते, ज्यामुळे त्यांच्या शिक्षणातील अडचणी दूर होतात आणि त्यांना स्वतःच्या पायावर उभे राहण्यास मदत मिळते.'
  },
  '2': {
    '0': 'लाभ घेणारा प्रवर्ग: सर्वसाधारण\n\nपायाभूत सुविधा संबंधित योजना\n   या योजनांचे तपशील उपलब्ध नाहीत.'
  },
  '3': {
    '1': 'लाभ घेणारा प्रवर्ग: सर्वसाधारण\n\n१. संस्था\n   प्रशिक्षण आणि कौशल्य विकासासाठी संस्था.\n\n   १.१ महात्मा ज्योतिबा फुले संशोधन व प्रशिक्षण संस्था (महाज्योती), नागपूर\n   इतर मागास प्रवर्ग, विमुक्त जाती, भटक्या जमाती आणि विशेष मागास प्रवर्गातील व्यक्तींसाठी संशोधन आणि प्रशिक्षण देणारी संस्था, जी कौशल्य विकासाला प्रोत्साहन देते. महाज्योती संस्था दरवर्षी १०,००० हून अधिक विद्यार्थ्यांना प्रशिक्षण देते, ज्यात संगणक प्रशिक्षण, उद्योजकता विकास आणि स्पर्धा परीक्षा मार्गदर्शन यांचा समावेश आहे. ही संस्था ओबीसी, विमुक्त जाती आणि भटक्या जमातींना प्राधान्य देते.\n\n   १.२ महाराष्ट्र संशोधन उत्थान व प्रशिक्षण प्रबोधिनी (अमृत)\n   खुल्या प्रवर्गातील व्यक्तींसाठी कौशल्य विकास आणि प्रशिक्षण देणारी संस्था. या संस्थेमार्फत विविध व्यावसायिक अभ्यासक्रम राबविले जातात, ज्यामुळे व्यक्तींना रोजगाराच्या संधी उपलब्ध होतात आणि त्यांचे जीवनमान सुधारते.'
  },
  '4': {
    '1': 'लाभ घेणारा प्रवर्ग: इतर मागास वर्ग, विमुक्त जाती, भटक्या जमाती आणि विशेष मागास प्रवर्ग\n\n१. महामंडळे\n   विकास महामंडळांमार्फत आर्थिक सहाय्य.\n\n   १.१ महाराष्ट्र राज्य इतर मागास वर्गीय वित्त आणि विकास महामंडळ\n   इतर मागास वर्गीय समुदायांसाठी आर्थिक सहाय्य.\n\n   १.१.१ शामराव पेजे आर्थिक विकास महामंडळ (उपकंपनी)\n   कोकण विभागातील इतर मागास प्रवर्गासाठी आर्थिक सहाय्य देणारी उपकंपनी, जी कमी व्याजदराने कर्ज पुरवते. ही उपकंपनी कोकणातील स्थानिक व्यवसाय जसे की मासेमारी, शेती आणि लघु उद्योगांना प्रोत्साहन देते.\n\n   १.१.२ जगदज्योती महात्मा बसवेश्वर आर्थिक विकास महामंडळ (उपकंपनी)\n   विशिष्ट इतर मागास प्रवर्गातील समाजासाठी आर्थिक सहाय्य देणारी उपकंपनी, जी कमी व्याजदराने कर्ज पुरवते. ही उपकंपनी विशेषतः वीरशैव-लिंगायत समाजाला लक्ष्य करते आणि त्यांच्या आर्थिक विकासासाठी कार्य करते.\n\n   १.१.३ संत रविदास मुद्रा युवा आर्थिक विकास महामंडळ (उपकंपनी)\n   विशिष्ट इतर मागास प्रवर्गातील समाजासाठी आर्थिक सहाय्य देणारी उपकंपनी, जी कमी व्याजदराने कर्ज पुरवते. ही उपकंपनी चर्मकार समाजाच्या तरुण उद्योजकांना स्वयंरोजगारासाठी प्रोत्साहन देते.\n\n   १.१.४ संत सेनाजी महाराज केशशिल्पी महामंडळ (उपकंपनी)\n   विशिष्ट इतर मागास प्रवर्गातील समाजासाठी आर्थिक सहाय्य देणारी उपकंपनी, जी कमी व्याजदराने कर्ज पुरवते. ही उपकंपनी न्हावी समाजाला लक्ष्य करते आणि त्यांच्या पारंपारिक व्यवसायाला आधुनिक स्वरूप देण्यासाठी मदत करते.\n\n   १.१.५ बीज भांडवल कर्ज योजना\n   या योजनेंतर्गत २५% महामंडळाचा सहभाग आणि ७५% बँकांचा सहभाग असतो. प्रकल्प मर्यादा ५.०० लाख रुपये आहे, व्याजदर ४%, आणि परतफेडीचा कालावधी ५ वर्षे आहे. या योजनेंतर्गत लाभार्थ्यांना व्यवसाय सुरू करण्यासाठी प्रारंभिक भांडवल मिळते, ज्यामुळे त्यांना स्वयंरोजगाराची संधी उपलब्ध होते. लाभार्थ्यांना व्यवसाय प्रशिक्षण देखील दिले जाते.\n\n   १.१.६ १०.०० लाखांपर्यंत थेट कर्ज योजना\n   १०.०० लाखांपर्यंत थेट कर्ज उपलब्ध आहे. लाभार्थ्यांचा सहभाग शून्य आहे. नियमित परतफेड करणाऱ्या लाभार्थ्यांना व्याज आकारले जाणार नाही; अन्यथा ४% व्याज आकारले जाते. या योजनेंतर्गत कर्जाची परतफेड १२ हप्त्यांत करावी लागते, आणि कर्ज मंजुरीसाठी ऑनलाइन अर्ज प्रक्रिया उपलब्ध आहे, ज्यामुळे प्रक्रिया जलद आणि पारदर्शी होते.\n\n   १.१.७ वैयक्तिक कर्ज व्याज परतावा योजना\n   १०.०० लाखांपर्यंतच्या कर्जावर १२% व्याजदरापर्यंत व्याज परतावा मिळतो, जो लाभार्थ्यांच्या बँक खात्यात दरमहा जमा केला जातो. या योजनेंतर्गत व्याज परतावा थेट लाभार्थ्यांच्या आधार लिंक केलेल्या बँक खात्यात जमा होतो, ज्यामुळे त्यांना आर्थिक भार कमी होतो.\n\n   १.१.८ गट कर्ज व्याज परतावा योजना\n   १०.०० लाख ते ५०.०० लाखांपर्यंतच्या गट कर्जावर १२% व्याजदरापर्यंत व्याज परतावा मिळतो, जो दरमहा गटाच्या बँक खात्यात जमा केला जातो. गट कर्ज योजनेंतर्गत ५ ते १० व्यक्तींचा समूह तयार करून कर्ज घेता येते, आणि गटातील सर्व सदस्यांना प्रशिक्षण आणि मार्गदर्शन दिले जाते.\n\n   १.२ वसंतराव नाईक विमुक्त जाती व भटक्या जमाती विकास महामंडळ\n   विमुक्त जाती व भटक्या जमाती समुदायांसाठी आर्थिक सहाय्य.\n\n   १.२.१ पैलवान के. मारुती चर्हाण-वडार आर्थिक विकास महामंडळ (उपकंपनी)\n   वडार समाजाच्या सामाजिक व आर्थिक उन्नतीसाठी स्थापन केलेली उपकंपनी, जी कमी व्याजदराने कर्ज पुरवते आणि स्वयंरोजगाराला प्रोत्साहन देते. वडार समाजातील व्यक्तींसाठी ही उपकंपनी पारंपारिक व्यवसाय जसे की दगड खणणे, बांधकाम यासह आधुनिक व्यवसाय जसे की लघु उद्योगांना प्रोत्साहन देते. या उपकंपनीमार्फत वडार समाजातील तरुणांना कौशल्य प्रशिक्षण आणि आर्थिक सहाय्य मिळते.\n\n   १.२.१.१ बीज भांडवल कर्ज योजना\n   या योजनेंतर्गत २५% महामंडळाचा सहभाग आणि ७५% बँकांचा सहभाग असतो. प्रकल्प मर्यादा ५.०० लाख रुपये आहे, व्याजदर ४%, आणि परतफेडीचा कालावधी ५ वर्षे आहे. या योजनेंतर्गत लाभार्थ्यांना व्यवसाय सुरू करण्यासाठी प्रारंभिक भांडवल मिळते, ज्यामुळे त्यांना स्वयंरोजगाराची संधी उपलब्ध होते. लाभार्थ्यांना व्यवसाय प्रशिक्षण देखील दिले जाते.\n\n   १.२.१.२ १०.०० लाखांपर्यंत थेट कर्ज योजना\n   १०.०० लाखांपर्यंत थेट कर्ज उपलब्ध आहे. लाभार्थ्यांचा सहभाग शून्य आहे. नियमित परतफेड करणाऱ्या लाभार्थ्यांना व्याज आकारले जाणार नाही; अन्यथा ४% व्याज आकारले जाते. या योजनेंतर्गत कर्जाची परतफेड १२ हप्त्यांत करावी लागते, आणि कर्ज मंजुरीसाठी ऑनलाइन अर्ज प्रक्रिया उपलब्ध आहे, ज्यामुळे प्रक्रिया जलद आणि पारदर्शी होते.\n\n   १.२.१.३ वैयक्तिक कर्ज व्याज परतावा योजना\n   १०.०० लाखांपर्यंतच्या कर्जावर १२% व्याजदरापर्यंत व्याज परतावा मिळतो, जो लाभार्थ्यांच्या बँक खात्यात दरमहा जमा केला जातो. या योजनेंतर्गत व्याज परतावा थेट लाभार्थ्यांच्या आधार लिंक केलेल्या बँक खात्यात जमा होतो, ज्यामुळे त्यांना आर्थिक भार कमी होतो.\n\n   १.२.१.४ गट कर्ज व्याज परतावा योजना\n   १०.०० लाख ते ५०.०० लाखांपर्यंतच्या गट कर्जावर १२% व्याजदरापर्यंत व्याज परतावा मिळतो, जो दरमहा गटाच्या बँक खात्यात जमा केला जातो. गट कर्ज योजनेंतर्गत ५ ते १० व्यक्तींचा समूह तयार करून कर्ज घेता येते, आणि गटातील सर्व सदस्यांना प्रशिक्षण आणि मार्गदर्शन दिले जाते.\n\n   १.२.२ राजे उमाजी नाईक जातीय विकास महामंडळ (उपकंपनी)\n   रामोशी समाजाच्या सामाजिक व आर्थिक उन्नतीसाठी स्थापन केलेली उपकंपनी, जी कमी व्याजदराने कर्ज पुरवते आणि स्वयंरोजगाराला प्रोत्साहन देते. रामोशी समाजातील व्यक्तींसाठी ही उपकंपनी शेती, पशुपालन आणि लघु उद्योगांसाठी कर्ज उपलब्ध करते, ज्यामुळे त्यांचे जीवनमान सुधारते. या उपकंपनीमार्फत रामोशी समाजातील व्यक्तींना आर्थिक स्वावलंबनासाठी मार्गदर्शन आणि प्रशिक्षण दिले जाते.\n\n   १.२.२.१ बीज भांडवल कर्ज योजना\n   या योजनेंतर्गत २५% महामंडळाचा सहभाग आणि ७५% बँकांचा सहभाग असतो. प्रकल्प मर्यादा ५.०० लाख रुपये आहे, व्याजदर ४%, आणि परतफेडीचा कालावधी ५ वर्षे आहे. या योजनेंतर्गत लाभार्थ्यांना व्यवसाय सुरू करण्यासाठी प्रारंभिक भांडवल मिळते, ज्यामुळे त्यांना स्वयंरोजगाराची संधी उपलब्ध होते. लाभार्थ्यांना व्यवसाय प्रशिक्षण देखील दिले जाते.\n\n   १.२.२.२ १०.०० लाखांपर्यंत थेट कर्ज योजना\n   १०.०० लाखांपर्यंत थेट कर्ज उपलब्ध आहे. लाभार्थ्यांचा सहभाग शून्य आहे. नियमित परतफेड करणाऱ्या लाभार्थ्यांना व्याज आकारले जाणार नाही; अन्यथा ४% व्याज आकारले जाते. या योजनेंतर्गत कर्जाची परतफेड १२ हप्त्यांत करावी लागते, आणि कर्ज मंजुरीसाठी ऑनलाइन अर्ज प्रक्रिया उपलब्ध आहे, ज्यामुळे प्रक्रिया जलद आणि पारदर्शी होते.\n\n   १.२.२.३ वैयक्तिक कर्ज व्याज परतावा योजना\n   १०.०० लाखांपर्यंतच्या कर्जावर १२% व्याजदरापर्यंत व्याज परतावा मिळतो, जो लाभार्थ्यांच्या बँक खात्यात दरमहा जमा केला जातो. या योजनेंतर्गत व्याज परतावा थेट लाभार्थ्यांच्या आधार लिंक केलेल्या बँक खात्यात जमा होतो, ज्यामुळे त्यांना आर्थिक भार कमी होतो.\n\n   १.२.२.४ गट कर्ज व्याज परतावा योजना\n   १०.०० लाख ते ५०.०० लाखांपर्यंतच्या गट कर्जावर १२% व्याजदरापर्यंत व्याज परतावा मिळतो, जो दरमहा गटाच्या बँक खात्यात जमा केला जातो. गट कर्ज योजनेंतर्गत ५ ते १० व्यक्तींचा समूह तयार करून कर्ज घेता येते, आणि गटातील सर्व सदस्यांना प्रशिक्षण आणि मार्गदर्शन दिले जाते.'
  },
  '5': {
    '0': 'लाभ घेणारा प्रवर्ग: सर्वसाधारण\n\nइतर योजना\n   या योजनांचे तपशील उपलब्ध नाहीत.'
  }
};

// Mapping of main scheme and sub-scheme numbers to image URLs
const schemeImages = {
  '1': {
    '1': null,
    '2': null,
    '3': null
  },
  '2': {
    '0': null
  },
  '3': {
    '1': null
  },
  '4': {
    '1': null
  },
  '5': {
    '0': null
  }
};

// Helper to send WhatsApp text messages via Twilio with message splitting
async function sendMessage(to, body) {
  const MAX_LENGTH = 1600; // WhatsApp message character limit
  try {
    // If message is under the limit, send it directly
    if (body.length <= MAX_LENGTH) {
      await client.messages.create({
        from: twilioWhatsAppNumber,
        to: to,
        body: body
      });
      console.log(`Text message sent to ${to}`);
    } else {
      // Split the message at newline boundaries
      const lines = body.split('\n');
      let currentChunk = '';
      const chunks = [];

      for (const line of lines) {
        // Add the line to the current chunk (including the newline)
        const lineWithNewline = line + '\n';
        if (currentChunk.length + lineWithNewline.length <= MAX_LENGTH) {
          currentChunk += lineWithNewline;
        } else {
          // If adding the line exceeds the limit, save the current chunk and start a new one
          if (currentChunk) {
            chunks.push(currentChunk.trimEnd()); // Remove trailing newline for cleanliness
          }
          currentChunk = lineWithNewline;
        }
      }

      // Add the last chunk if it exists
      if (currentChunk) {
        chunks.push(currentChunk.trimEnd());
      }

      // Send each chunk as a separate message
      for (const chunk of chunks) {
        await client.messages.create({
          from: twilioWhatsAppNumber,
          to: to,
          body: chunk
        });
        console.log(`Text message chunk sent to ${to}`);
        // Add a small delay to ensure messages are sent in order
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }
  } catch (error) {
    console.error('Error sending text message:', error.message);
  }
}

// Helper to send WhatsApp image messages via Twilio
async function sendImage(to, imageUrl, caption = '') {
  try {
    await client.messages.create({
      from: twilioWhatsAppNumber,
      to: to,
      mediaUrl: [imageUrl],
      body: caption
    });
    console.log(`Image message sent to ${to}`);
  } catch (error) {
    console.error('Error sending image message:', error.message);
  }
}

// List of main schemes
async function sendMainSchemesList(to) {
  const schemes = [
    '0. मेन्यू परत जा',
    '1. शैक्षणिक योजना',
    '2. पायाभूत सुविधा संबंधित योजना',
    '3. कौशल्य विकासाच्या योजना',
    '4. अर्थसहाय्याच्या योजना',
    '5. इतर योजना'
  ].join('\n');

  const message = `नमस्कार! विभागा अंतर्गत राबविल्या जाणाऱ्या योजनांमध्ये आपले स्वागत आहे.\nकृपया एक योजना निवडा:\n\n${schemes}\n\nक्रमांकासह उत्तर द्या (उदा., 1). मेन्यूवर परत जाण्यासाठी 0 सह उत्तर द्या.`;
  await sendMessage(to, message);
}

// List of sub-schemes for a selected main scheme
async function sendSubSchemesList(to, mainScheme) {
  const subSchemesList = subSchemes[mainScheme];
  if (subSchemesList.length === 0) {
    const details = subSchemeDetails[mainScheme]['0'];
    const imageUrl = schemeImages[mainScheme]['0'];
    if (imageUrl) {
      await sendImage(to, imageUrl, `तपशील:`);
    }
    await sendMessage(to, `${details}\n\nमागील मेन्यूवर परत जाण्यासाठी 0 सह उत्तर द्या.`);
  } else {
    const message = `कृपया खालील योजनांमधून एक निवडा:\n\n0. मागील मेन्यू परत जा\n${subSchemesList.join('\n')}\n\nक्रमांकासह उत्तर द्या (उदा., 1). मागील मेन्यूवर परत जाण्यासाठी 0 सह उत्तर द्या.`;
    await sendMessage(to, message);
  }
}

// Webhook to handle incoming messages from Twilio
app.post('/webhook', async (req, res) => {
  const from = req.body.From;
  const messageBody = req.body.Body;

  if (!userState[from]) {
    userState[from] = { step: 'mainSchemes' };
    await sendMainSchemesList(from);
  } else if (userState[from].step === 'mainSchemes') {
    const choice = messageBody;
    if (/^\d+$/.test(choice)) {
      if (choice === '0') {
        userState[from] = { step: 'mainSchemes' };
        await sendMainSchemesList(from);
      } else if (choice >= 1 && choice <= 5) { // 5 main schemes
        userState[from] = { step: 'subSchemes', mainScheme: choice };
        await sendSubSchemesList(from, choice);
      } else {
        await sendMessage(from, 'कृपया 0 ते 5 मधील एक वैध क्रमांक निवडा. मेन्यूवर परत जाण्यासाठी 0 सह उत्तर द्या.');
      }
    } else {
      await sendMessage(from, 'कृपया 0 ते 5 मधील एक वैध क्रमांक निवडा. मेन्यूवर परत जाण्यासाठी 0 सह उत्तर द्या.');
    }
  } else if (userState[from].step === 'subSchemes') {
    const mainScheme = userState[from].mainScheme;
    const choice = messageBody;
    const maxSubScheme = subSchemes[mainScheme].length;

    if (/^\d+$/.test(choice)) {
      if (choice === '0') {
        userState[from] = { step: 'mainSchemes' };
        await sendMainSchemesList(from);
      } else if (choice >= 1 && choice <= maxSubScheme) {
        const details = subSchemeDetails[mainScheme][choice];
        const imageUrl = schemeImages[mainScheme][choice];
        if (imageUrl) {
          await sendImage(from, imageUrl, `${subSchemes[mainScheme][choice - 1]} साठी तपशील:`);
        }
        await sendMessage(from, `${details}\n\nमागील मेन्यूवर परत जाण्यासाठी 0 सह उत्तर द्या.`);
      } else {
        await sendMessage(from, `कृपया 0 ते ${maxSubScheme} मधील एक वैध क्रमांक निवडा. मागील मेन्यूवर परत जाण्यासाठी 0 सह उत्तर द्या.`);
      }
    } else {
      await sendMessage(from, `कृपया 0 ते ${maxSubScheme} मधील एक वैध क्रमांक निवडा. मागील मेन्यूवर परत जाण्यासाठी 0 सह उत्तर द्या.`);
    }
  }

  res.status(200).send('OK');
});

// Basic route for testing
app.get('/', (req, res) => {
  res.send('व्हॉट्सअॅप चॅटबॉट सुरू आहे!');
});

app.listen(3000, () => console.log('Server running on port 3000'));